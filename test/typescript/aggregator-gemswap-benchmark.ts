import { expect } from "chai";
import { ethers } from "hardhat";
import {
  BAYC,
  LOOKSRARE_EXTRA_DATA_SCHEMA,
  LOOKSRARE_STRATEGY_FIXED_PRICE,
  SEAPORT_EXTRA_DATA_SCHEMA,
  WETH,
  SEAPORT_OFFER_FULFILLMENT_TWO_ITEMS,
  SEAPORT_CONSIDERATION_FULFILLMENTS_TWO_ORDERS_SAME_COLLECTION,
} from "../constants";
import getFixture from "./utils/get-fixture";
import getSeaportOrderExtraData from "./utils/get-seaport-order-extra-data";
import getSeaportOrderJson from "./utils/get-seaport-order-json";
import combineConsiderationAmount from "./utils/combine-consideration-amount";

import { loadFixture } from "@nomicfoundation/hardhat-network-helpers";
import deployMultipleMarketFixtures from "./fixtures/deploy-multiple-markets-fixture";
import validateSweepEvent from "./utils/validate-sweep-event";

describe("Aggregator", () => {
  it("Using LooksRareAggregator", async function () {
    const { aggregator, looksRareProxy, looksRareFunctionSelector, seaportProxy, seaportFunctionSelector, bayc } =
      await loadFixture(deployMultipleMarketFixtures);
    const seaportOrderOne = getFixture("seaport", "bayc-9477-order.json");
    const seaportOrderTwo = getFixture("seaport", "bayc-4560-order.json");

    const seaportPriceOne = combineConsiderationAmount(seaportOrderOne.parameters.consideration);
    const seaportPriceTwo = combineConsiderationAmount(seaportOrderTwo.parameters.consideration);
    const seaportPrice = seaportPriceOne.add(seaportPriceTwo);
    const looksRarePriceOne = ethers.utils.parseEther("73.88");
    const looksRarePriceTwo = ethers.utils.parseEther("74");
    const looksRarePrice = looksRarePriceOne.add(looksRarePriceTwo);
    const price = seaportPrice.add(looksRarePrice);

    const abiCoder = ethers.utils.defaultAbiCoder;
    const tradeData = [
      {
        proxy: seaportProxy.address,
        selector: seaportFunctionSelector,
        value: seaportPrice,
        orders: [getSeaportOrderJson(seaportOrderOne), getSeaportOrderJson(seaportOrderTwo)],
        ordersExtraData: [getSeaportOrderExtraData(seaportOrderOne), getSeaportOrderExtraData(seaportOrderTwo)],
        extraData: abiCoder.encode(
          [SEAPORT_EXTRA_DATA_SCHEMA],
          [
            {
              offerFulfillments: SEAPORT_OFFER_FULFILLMENT_TWO_ITEMS,
              considerationFulfillments: SEAPORT_CONSIDERATION_FULFILLMENTS_TWO_ORDERS_SAME_COLLECTION,
            },
          ]
        ),
      },
      {
        proxy: looksRareProxy.address,
        selector: looksRareFunctionSelector,
        value: looksRarePrice,
        orders: [
          {
            signer: "0x17331428346E388f32013e6bEc0Aba29303857FD",
            collection: BAYC,
            collectionType: 0,
            tokenIds: [9483],
            amounts: [1],
            price: looksRarePriceOne,
            currency: WETH,
            startTime: 1662683712,
            endTime: 1663288508,
            signature:
              "0x137b835f53750e28c2ca2c14686206fc1b5e44b47b22f619ae35ac7e661de1fa2d22c786fd897ad08ae30113d1a8804e2313b6410438ba9187e14e94ef25e4671c",
          },
          {
            signer: "0x290dC64Bd6B079d0Fe41c8383D720938Bfa69cB1",
            collection: BAYC,
            collectionType: 0,
            tokenIds: [3569],
            amounts: [1],
            price: looksRarePriceTwo,
            currency: WETH,
            startTime: 1662522412,
            endTime: 1664367698,
            signature:
              "0xc0b72a9fc4068e489c0464b44c6e93ff28c24e30bb2ff1776d6afbc23d8235e75d4c996bf069c445133dcdc01dd1615fedfbb4a3e43fc539d5795215baf767101b",
          },
        ],
        ordersExtraData: [
          abiCoder.encode(LOOKSRARE_EXTRA_DATA_SCHEMA, [looksRarePriceOne, 9550, 860, LOOKSRARE_STRATEGY_FIXED_PRICE]),
          abiCoder.encode(LOOKSRARE_EXTRA_DATA_SCHEMA, [looksRarePriceTwo, 9550, 9, LOOKSRARE_STRATEGY_FIXED_PRICE]),
        ],
        extraData: ethers.constants.HashZero,
      },
    ];

    await ethers.provider.send("hardhat_impersonateAccount", ["0xbF3aEB96e164ae67E763D9e050FF124e7c3Fdd28"]);
    const buyer = await ethers.getSigner("0xbF3aEB96e164ae67E763D9e050FF124e7c3Fdd28");

    const tx = await aggregator.connect(buyer).execute([], tradeData, buyer.address, false, { value: price });
    const receipt = await tx.wait();
    validateSweepEvent(receipt, buyer.address);

    expect(await bayc.balanceOf(buyer.address)).to.equal(4);
    expect(await bayc.ownerOf(9477)).to.equal(buyer.address);
    expect(await bayc.ownerOf(4560)).to.equal(buyer.address);
    expect(await bayc.ownerOf(9483)).to.equal(buyer.address);
    expect(await bayc.ownerOf(3569)).to.equal(buyer.address);
  });

  it("Using GemSwap", async function () {
    const aggregator = await ethers.getContractAt("IGemSwap", "0x83C8F28c26bF6aaca652Df1DbBE0e1b56F8baBa2");
    await ethers.provider.send("hardhat_impersonateAccount", ["0xbF3aEB96e164ae67E763D9e050FF124e7c3Fdd28"]);
    const buyer = await ethers.getSigner("0xbF3aEB96e164ae67E763D9e050FF124e7c3Fdd28");
    const bayc = await ethers.getContractAt("@openzeppelin/contracts/token/ERC721/IERC721.sol:IERC721", BAYC);

    const seaportOrderOne = getFixture("seaport", "bayc-9477-order.json");
    const seaportOrderTwo = getFixture("seaport", "bayc-4560-order.json");

    const seaportPriceOne = combineConsiderationAmount(seaportOrderOne.parameters.consideration);
    const seaportPriceTwo = combineConsiderationAmount(seaportOrderTwo.parameters.consideration);
    const seaportPrice = seaportPriceOne.add(seaportPriceTwo);
    const looksRarePriceOne = ethers.utils.parseEther("73.88");
    const looksRarePriceTwo = ethers.utils.parseEther("74");
    const looksRarePrice = looksRarePriceOne.add(looksRarePriceTwo);
    const price = seaportPrice.add(looksRarePrice);

    const tradeDetails = [
      {
        marketId: 18,
        value: seaportPrice,
        tradeData:
          "0x540616370000000000000000000000000000000000000000000000000000000000000040000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000e00000000000000000000000000000000000000000000000000000000000000cc00000000000000000000000000000000000000000000000000000000000000ce00000000000000000000000000000000000000000000000000000000000000e0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000002000000000000000000000000000000000000000000000007e5dadb19eea9000000000000000000000000000000000000000000000000000000000000000000020000000000000000000000000000000000000000000000000000000000000040000000000000000000000000000000000000000000000000000000000000060000000000000000000000000000000000000000000000000000000000000000a000000000000000000000000000000000000000000000000000000000000000010000000000000000000000000000000000000000000000000000000000000001000000000000000000000000000000000000000000000000000000000000052000000000000000000000000000000000000000000000000000000000000005a00000000000000000000000002ce485fe158593b9f3d4b840f1e44e3b77c96741000000000000000000000000004c00500000ad104d7dbd00e3ae0a5c00560c00000000000000000000000000000000000000000000000000000000000000016000000000000000000000000000000000000000000000000000000000000002200000000000000000000000000000000000000000000000000000000000000002000000000000000000000000000000000000000000000000000000006319fc0c00000000000000000000000000000000000000000000000000000000633f47b4000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000681f8d5fd259040000007b02230091a7ed01230072f7006a004d60a8d4e71d599b8104250f0000000000000000000000000000000000000000000000000000000000000000000300000000000000000000000000000000000000000000000000000000000000010000000000000000000000000000000000000000000000000000000000000002000000000000000000000000bc4ca0eda7647a8ab7c2061c2e118a18a936f13d0000000000000000000000000000000000000000000000000000000000002505000000000000000000000000000000000000000000000000000000000000000100000000000000000000000000000000000000000000000000000000000000010000000000000000000000000000000000000000000000000000000000000003000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000003be566b60d6fcc000000000000000000000000000000000000000000000000003be566b60d6fcc0000000000000000000000000002ce485fe158593b9f3d4b840f1e44e3b77c9674100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000019382b3f2e14200000000000000000000000000000000000000000000000000019382b3f2e1420000000000000000000000000000000a26b00c1f0df003000390027140000faa71900000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000019382b3f2e14200000000000000000000000000000000000000000000000000019382b3f2e142000000000000000000000000000a858ddc0445d8131dac4d1de01f834ffcba52ef10000000000000000000000000000000000000000000000000000000000000041f417064fb086c6e00d96a8a6045cf6b6349359e6646ec87d633d4b64afc0a09401b612068a34a5fa1d5c3149dc432988312d881b60d9adbacceeb76135ad69621b00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000a000000000000000000000000000000000000000000000000000000000000000010000000000000000000000000000000000000000000000000000000000000001000000000000000000000000000000000000000000000000000000000000052000000000000000000000000000000000000000000000000000000000000005a0000000000000000000000000a27503e089ef0e37d6eaf28aa444c46eb9fd9e40000000000000000000000000004c00500000ad104d7dbd00e3ae0a5c00560c0000000000000000000000000000000000000000000000000000000000000001600000000000000000000000000000000000000000000000000000000000000220000000000000000000000000000000000000000000000000000000000000000200000000000000000000000000000000000000000000000000000000631b3c4a00000000000000000000000000000000000000000000000000000000633944e30000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000012cf943a204d79a0000007b02230091a7ed01230072f7006a004d60a8d4e71d599b8104250f0000000000000000000000000000000000000000000000000000000000000000000300000000000000000000000000000000000000000000000000000000000000010000000000000000000000000000000000000000000000000000000000000002000000000000000000000000bc4ca0eda7647a8ab7c2061c2e118a18a936f13d00000000000000000000000000000000000000000000000000000000000011d0000000000000000000000000000000000000000000000000000000000000000100000000000000000000000000000000000000000000000000000000000000010000000000000000000000000000000000000000000000000000000000000003000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000003c26cb19165570000000000000000000000000000000000000000000000000003c26cb19165570000000000000000000000000000a27503e089ef0e37d6eaf28aa444c46eb9fd9e400000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000001953b3d4ab1680000000000000000000000000000000000000000000000000001953b3d4ab1680000000000000000000000000000000a26b00c1f0df003000390027140000faa7190000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000001953b3d4ab1680000000000000000000000000000000000000000000000000001953b3d4ab168000000000000000000000000000a858ddc0445d8131dac4d1de01f834ffcba52ef100000000000000000000000000000000000000000000000000000000000000419f4a7f1eb8070e675987bff93aba879e469de1fe4a05294c6456bc7afa99b45d622a06b9a7f8fc5fef63cdbdfb837e88806e964a6d93406291eb05906af26c681b00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000002000000000000000000000000000000000000000000000000000000000000004000000000000000000000000000000000000000000000000000000000000000a00000000000000000000000000000000000000000000000000000000000000001000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000001000000000000000000000000000000000000000000000000000000000000000100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000004000000000000000000000000000000000000000000000000000000000000008000000000000000000000000000000000000000000000000000000000000000e0000000000000000000000000000000000000000000000000000000000000018000000000000000000000000000000000000000000000000000000000000002200000000000000000000000000000000000000000000000000000000000000001000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000002000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000010000000000000000000000000000000000000000000000000000000000000001000000000000000000000000000000000000000000000000000000000000000100000000000000000000000000000000000000000000000000000000000000020000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000200000000000000000000000000000000000000000000000000000000000000010000000000000000000000000000000000000000000000000000000000000002000000000000000000000000000000000000000000000000000000000000000100000000000000000000000000000000000000000000000000000000000000010000000000000000000000000000000000000000000000000000000000000000",
      },
      {
        marketId: 16,
        value: looksRarePrice,
        tradeData:
          "0xf3e816230000000000000000000000000000000000000000000000000000000000000040000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000020000000000000000000000000000000000000000000000000000000000000001000000000000000000000000000000000000000000000004014a7c9125dc0000000000000000000000000000000000000000000000000000000000000000250b0000000000000000000000000000000000000000000000000000000000000001000000000000000000000000000000000000000000000000000000000000035c00000000000000000000000000000000000000000000000000000000631a8a40000000000000000000000000000000000000000000000000000000006323c4bc000000000000000000000000000000000000000000000000000000000000254e000000000000000000000000000000000000000000000000000000000000001c137b835f53750e28c2ca2c14686206fc1b5e44b47b22f619ae35ac7e661de1fa2d22c786fd897ad08ae30113d1a8804e2313b6410438ba9187e14e94ef25e46700000000000000000000000017331428346e388f32013e6bec0aba29303857fd000000000000000000000000bc4ca0eda7647a8ab7c2061c2e118a18a936f13d000000000000000000000000000000000000000000000000000000000000000100000000000000000000000000000000000000000000000402f4cfee62e800000000000000000000000000000000000000000000000000000000000000000df100000000000000000000000000000000000000000000000000000000000000010000000000000000000000000000000000000000000000000000000000000009000000000000000000000000000000000000000000000000000000006318142c0000000000000000000000000000000000000000000000000000000063343c52000000000000000000000000000000000000000000000000000000000000254e000000000000000000000000000000000000000000000000000000000000001bc0b72a9fc4068e489c0464b44c6e93ff28c24e30bb2ff1776d6afbc23d8235e75d4c996bf069c445133dcdc01dd1615fedfbb4a3e43fc539d5795215baf76710000000000000000000000000290dc64bd6b079d0fe41c8383d720938bfa69cb1000000000000000000000000bc4ca0eda7647a8ab7c2061c2e118a18a936f13d",
      },
    ];

    const tx = await aggregator.connect(buyer).batchBuyWithETH(tradeDetails, { value: price });
    await tx.wait();

    expect(await bayc.balanceOf(buyer.address)).to.equal(4);
    expect(await bayc.ownerOf(9477)).to.equal(buyer.address);
    expect(await bayc.ownerOf(4560)).to.equal(buyer.address);
    expect(await bayc.ownerOf(9483)).to.equal(buyer.address);
    expect(await bayc.ownerOf(3569)).to.equal(buyer.address);
  });
});
